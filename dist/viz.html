<!DOCTYPE html>
<meta charset="utf-8">
<style>
	
	body,html{
		margin:0;
		padding:0;
		font-family: sans-serif;
	}

	.link {
		fill: none;
		stroke: rgba(0,0,0,.3);
	}

	.linkLabel {
		fill: rgba(0,0,0,.3);
		opacity:0;
		transition: all .1s ease;
	}

	.card {
		user-select: none;
		fill: #ddd;
		stroke:#ddd;
		box-shadow: -5px -5px 5px #000;
		cursor: pointer;
	}


</style>
<body>
	<script src="//d3js.org/d3.v4.min.js"></script>
	<script>
		var RADIUS = 100;
		var width = document.body.clientWidth,
		height = 2000;

		var json = [
		{
			title: "Card 1",
			answers: [
			{t:"Answer a",link:1, clicks:6},
			{t:"Answer b",link:1, clicks:2}
			]
		},

		{
			title: "Card 2",
			
			answers: [
			{t:"Answer a",link:3, clicks:3},
			{t:"Answer b",link:2, clicks:4}
			]
		},

		{
			title: "Card 3",
			
			answers: [
			{t:"Answer a",link:3, clicks:0},
			{t:"Answer b",link:3, clicks:1}
			]
		},

		{
			title: "End"
		}

		]



		var linksData = [];

		json.forEach(function(d,i) {
			if(d.answers) {
				d.answers.forEach(function(answer, i) {
					if(answer.link != -1) {

						linksData.push({
							clicks: answer.clicks,
							answerIndex: i,
							source: d ,
							target: json[answer.link]
						})

					}
				})
			}
		})





		var svg = d3.select("body").append("svg")
		.attr("width", width)
		.attr("height", height);

		svg
		.append("defs")
		.append("marker")
		.attr("id", "arrow")
		.attr("viewBox", "0 -5 10 10")
		.attr("markerWidth", 3)
		.attr("markerHeight", 3)
		.attr("orient", "auto")
		.append("path")
		.attr("fill", "rgba(0,0,0,.5)")
		.attr("d", "M0,-5L10,0L0,5");

		var nodes = svg
		.selectAll(".node")
		.data(json)
		.enter()
		.append("g")
		.call(d3.drag()
			.on("start", dragstarted)
			.on("drag", dragged)
			.on("end", dragended));

		nodes
		.append("circle")
		.attr("class", "card")
		.attr("r", RADIUS*.93)
		.on('mouseover', function() {
			linksLabel.style("opacity", 1)
		})
		.on('mouseout', function() {
			linksLabel.style("opacity", 0)
		})

		// nodes
		// .append("rect")
		// .attr("class", "card")
		// .attr("x", -RADIUS*3/2)
		// .attr("y", -RADIUS*1.618/2)
		// .attr("width", RADIUS*3)
		// .attr("height", RADIUS*1.618)



		nodes
		.append("text")
		.text(function(d) {return d.title})
		.attr("text-anchor", "middle")
		.attr("y", -50)


		nodes
		.each(function(d) {
			if(d.answers) {
				d3.select(this)
				.append("text")
				.text(d.answers[0].t)
				.attr("text-anchor", "middle")
				.attr("x", -50)
				.attr("y", 20)

				d3.select(this)
				.append("text")
				.text(d.answers[1].t)
				.attr("text-anchor", "middle")
				.attr("x", 50)
				.attr("y", 20)
			}
		})
		




		var simulation = d3.forceSimulation(json)
		.force("charge", d3.forceCollide(100))
		.force("x", d3.forceX(width/2))
		.force("y", d3.forceY(function(d, i) {
			return i * 300 + 250
		}))

		var links = svg
		.selectAll(".link")
		.data(linksData)
		.enter()
		.append("path")
		.attr("class", "link")
		.each(function(d) {
			d3.select(this)
			.attr("marker-end", "url(#arrow)")
			.style("stroke-width",d.clicks+1)
		})

		var linksLabel = svg
		.selectAll(".linkLabel")
		.data(linksData)
		.enter()
		.append("text")
		.attr("class", "linkLabel")
		.text(function(d) {return d.clicks})


		window.requestAnimationFrame(ticked)


		var line = d3.line()
		.x(function(d) { return d.x; })
		.y(function(d) { return d.y; })
		.curve(d3.curveCardinal);

		function linkArc(points, d) {
			var source = points[0];
			var target = points[1];
			var largeArcFlag = d == 0 ? 0 : 1;
			var dx = target.x - source.x,
			dy = target.y - source.y,
			dr = Math.sqrt(dx * dx + dy * dy);
			return "M" + source.x + "," + source.y + "A" + dr + "," + dr + " 0 0, "  + largeArcFlag + " " + target.x + "," + target.y;
		}



		var getLinkPositions = function(d) {
			var xoffset = d.answerIndex == 0 ? -50 : 50;
			var sourceX = d.source.x+xoffset;
			var sourceY = d.source.y + RADIUS/2;
			var targetX = d.target.x+xoffset;
			var targetY = d.target.y -RADIUS*1.618/2;
			return [{x:sourceX, y:sourceY}, {x:targetX, y:targetY}]
		}

		function dragstarted(d) {
			console.log(d)
			if (!d3.event.active) simulation.alphaTarget(1).restart();
			d3.event.subject.fx = d3.event.subject.x;
			d3.event.subject.fy = d3.event.subject.y;
		}

		function dragged(d) {
			d3.event.subject.fx = d3.event.x;
			d3.event.subject.fy = d3.event.y;
		}

		function dragended(d) {
			console.log(d)
			if (!d3.event.active) simulation.alphaTarget(0);
			d3.event.subject.fx = null;
			d3.event.subject.fy = null;
		}



		function ticked() {
			links.attr("d", function(d) { return linkArc(getLinkPositions(d),d.answerIndex)})
			linksLabel.attr("x", function(d) {
				var positions = getLinkPositions(d);
				return positions[0].x;
			})
			linksLabel.attr("y", function(d) {
				var positions = getLinkPositions(d);
				return positions[0].y + 50;
			})
			nodes.style("transform", function(d) {return "translate("+d.x+"px, "+d.y+"px)" })
			window.requestAnimationFrame(ticked)
		}

	</script>
